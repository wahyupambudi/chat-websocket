<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grup Chat WebSocket</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="./output.css" rel="stylesheet">
</head>

<body class="font-poppins bg-gray-100 flex justify-center items-start min-h-screen p-4 md:p-8">

    <div
        class="chat-app-container flex flex-col md:flex-row w-full max-w-7xl bg-white rounded-lg shadow-xl overflow-hidden my-4 md:my-8">

        <div
            class="user-list-sidebar w-full md:w-72 bg-gray-50 p-4 md:p-6 border-b md:border-b-0 md:border-r border-gray-200 flex flex-col">
            <h3 class="text-xl font-semibold text-gray-700 mb-4">User Online</h3>

            <div class="user-init-container bg-blue-50 p-4 rounded-lg mb-6 shadow-sm">
                <input type="text" id="user-name-input" placeholder="Masukkan nama Anda..."
                    class="w-full p-2 border border-blue-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm mb-3">
                <button id="set-user-name-button"
                    class="w-full bg-green-600 text-white py-2 px-4 rounded-md font-medium hover:bg-green-700 transition duration-200 text-sm">
                    Gabung Chat
                </button>
                <div id="current-user-info" class="mt-3 text-sm font-semibold text-blue-700 text-center"></div>
            </div>

            <ul id="user-list" class="flex-grow overflow-y-auto custom-scrollbar">
                <li data-user="all"
                    class="flex items-center p-3 cursor-pointer rounded-md mb-2 bg-blue-500 text-white font-medium hover:bg-blue-600 transition duration-200 selected">
                    <span class="user-status-indicator w-2.5 h-2.5 rounded-full bg-green-400 mr-3 shadow-md"></span>
                    Semua (Public Chat)
                </li>
            </ul>
        </div>

        <div class="chat-area flex-grow flex flex-col">
            <div class="chat-header p-4 md:p-5 bg-blue-100 border-b border-gray-200 flex justify-between items-center">
                <h2 class="text-lg md:text-xl font-semibold text-gray-800">Chat dengan <span id="current-recipient"
                        class="text-blue-700">Semua</span></h2>
            </div>
            <div id="chat-box"
                class="flex-grow p-4 overflow-y-auto bg-gray-50 custom-scrollbar max-h-[calc(100vh-18rem)] md:max-h-[calc(100vh-4rem)]">
            </div>
            <div class="message-input-area flex p-4 border-t border-gray-200 bg-gray-50">
                <input type="text" id="message-input" placeholder="Ketik pesan Anda..." disabled
                    class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400 text-sm disabled:bg-gray-100 disabled:cursor-not-allowed">
                <button id="send-button" disabled
                    class="ml-3 px-5 py-3 bg-blue-600 text-white rounded-full font-medium hover:bg-blue-700 transition duration-200 text-sm disabled:bg-blue-300 disabled:cursor-not-allowed">
                    Kirim
                </button>
            </div>
        </div>
    </div>

    <script>
        const chatBox = document.getElementById('chat-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const userNameInput = document.getElementById('user-name-input');
        const setUserNameButton = document.getElementById('set-user-name-button');
        const currentUserInfo = document.getElementById('current-user-info');
        const currentRecipientSpan = document.getElementById('current-recipient');
        const userList = document.getElementById('user-list');

        let ws = null; // WebSocket connection object
        let myUserName = '';
        let currentRecipient = 'all'; // Default recipient is 'all' (public chat)

        // --- Event Listeners ---
        setUserNameButton.addEventListener('click', () => {
            const userName = userNameInput.value.trim();
            if (userName) {
                myUserName = userName;
                connectWebSocket();
                userNameInput.disabled = true;
                setUserNameButton.disabled = true;
                messageInput.disabled = false;
                sendButton.disabled = false;
                currentUserInfo.textContent = `Anda: ${myUserName}`;
            } else {
                alert('Nama pengguna tidak boleh kosong!');
            }
        });

        sendButton.addEventListener('click', () => {
            sendMessage();
        });

        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        userList.addEventListener('click', (e) => {
            const targetLi = e.target.closest('li');
            if (targetLi && targetLi.dataset.user) { // Ensure it's a list item with data-user
                // Remove previous selection
                const currentSelected = userList.querySelector('.selected');
                if (currentSelected) {
                    currentSelected.classList.remove('selected');
                }
                // Add new selection
                targetLi.classList.add('selected');
                currentRecipient = targetLi.dataset.user;
                currentRecipientSpan.textContent = currentRecipient === 'all' ? 'Semua' : currentRecipient;
                addSystemMessage(`Anda sekarang mengirim pesan ke: ${currentRecipient === 'all' ? 'Semua' : currentRecipient}`);
            }
        });

        // --- WebSocket Connection ---
        function connectWebSocket() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.close();
            }
            ws = new WebSocket('ws://localhost:3000');

            ws.onopen = () => {
                addSystemMessage('Terhubung ke server chat.');
                // Kirim pesan inisialisasi nama pengguna ke server
                ws.send(`init_user:${myUserName}`);
            };

            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.type === 'chat_message') {
                        if (data.sender === myUserName || data.recipient === 'self') {
                            addMessage(data.sender, data.content, 'self');
                        } else {
                            addMessage(data.sender, data.content, 'other');
                        }
                    } else if (data.type === 'private_message') {
                        addMessage(data.sender, data.content, 'private');
                    } else if (data.type === 'private_message_sent') {
                        addMessage(`${data.recipient} (Pribadi Anda)`, data.content, 'self private');
                    } else if (data.type === 'error') {
                        addSystemMessage(`ERROR: ${data.message}`);
                    } else if (data.type === 'user_list') {
                        updateUserList(data.users);
                    } else {
                        addSystemMessage(event.data);
                    }
                } catch (e) {
                    addSystemMessage(event.data);
                    console.warn('Received non-JSON message or parse error:', event.data, e);
                }
            };

            ws.onclose = () => {
                addSystemMessage('Terputus dari server chat.');
                messageInput.disabled = true;
                sendButton.disabled = true;
                userNameInput.disabled = false;
                setUserNameButton.disabled = false;
                myUserName = '';
                currentUserInfo.textContent = '';
                currentRecipient = 'all';
                currentRecipientSpan.textContent = 'Semua';
                userList.innerHTML = `
                    <li data-user="all" class="flex items-center p-3 cursor-pointer rounded-md mb-2 bg-blue-500 text-white font-medium hover:bg-blue-600 transition duration-200 selected">
                        <span class="user-status-indicator w-2.5 h-2.5 rounded-full bg-green-400 mr-3 shadow-md"></span>
                        Semua (Public Chat)
                    </li>
                `;
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addSystemMessage('Terjadi kesalahan koneksi.');
            };
        }

        // --- Message and UI Functions ---
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message && ws && ws.readyState === WebSocket.OPEN && myUserName) {
                const chatMessage = {
                    type: 'chat_message',
                    sender: myUserName,
                    recipient: currentRecipient,
                    content: message
                };
                ws.send(JSON.stringify(chatMessage));
                messageInput.value = ''; // Clear input
            }
        }

        function addMessage(sender, content, type = 'other') {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('flex', 'mb-2', 'items-end', 'max-w-[90%]');

            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('p-3', 'rounded-2xl', 'leading-tight', 'shadow-sm', 'text-sm');

            const senderSpan = document.createElement('div');
            senderSpan.classList.add('font-semibold', 'text-xs', 'mb-1');

            const contentP = document.createElement('p');
            contentP.textContent = content;

            if (type === 'self') {
                messageContainer.classList.add('ml-auto', 'justify-end');
                messageContentDiv.classList.add('bg-blue-600', 'text-white', 'rounded-br-sm');
                senderSpan.classList.add('text-blue-200', 'text-right');
                senderSpan.textContent = 'Anda';
            } else if (type === 'other') {
                messageContainer.classList.add('mr-auto', 'justify-start');
                messageContentDiv.classList.add('bg-gray-200', 'text-gray-800', 'rounded-bl-sm');
                senderSpan.classList.add('text-gray-600', 'text-left');
                senderSpan.textContent = sender;
            } else if (type === 'private') {
                messageContainer.classList.add('mr-auto', 'justify-start');
                messageContentDiv.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-300', 'rounded-bl-sm');
                senderSpan.classList.add('text-yellow-700', 'text-left');
                senderSpan.textContent = `PRIBADI dari ${sender}`;
            }

            if (type !== 'system') {
                messageContentDiv.prepend(senderSpan); // Add sender name before content
            }
            messageContentDiv.appendChild(contentP);
            messageContainer.appendChild(messageContentDiv);
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function addSystemMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.classList.add('flex', 'justify-center', 'w-full', 'my-2'); // Center the system message

            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('text-gray-500', 'italic', 'text-xs', 'text-center', 'px-3', 'py-1', 'rounded-full', 'bg-gray-100', 'max-w-md'); // Style for system message
            messageContentDiv.textContent = message;

            messageContainer.appendChild(messageContentDiv);
            chatBox.appendChild(messageContainer);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function updateUserList(users) {
            userList.innerHTML = ''; // Clear current list

            // Add "Semua (Public Chat)" option first
            const allOption = document.createElement('li');
            allOption.dataset.user = 'all';
            allOption.classList.add('flex', 'items-center', 'p-3', 'cursor-pointer', 'rounded-md', 'mb-2', 'font-medium', 'transition', 'duration-200');
            allOption.innerHTML = `<span class="user-status-indicator w-2.5 h-2.5 rounded-full bg-green-400 mr-3 shadow-md"></span>Semua (Public Chat)`;
            if (currentRecipient === 'all') {
                allOption.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600', 'selected');
            } else {
                allOption.classList.add('text-gray-700', 'hover:bg-gray-100');
            }
            userList.appendChild(allOption);

            // Add other online users
            users.forEach(user => {
                if (user !== myUserName) { // Jangan tampilkan diri sendiri di daftar user lain
                    const li = document.createElement('li');
                    li.dataset.user = user;
                    li.classList.add('flex', 'items-center', 'p-3', 'cursor-pointer', 'rounded-md', 'mb-2', 'font-medium', 'transition', 'duration-200');
                    li.innerHTML = `<span class="user-status-indicator w-2.5 h-2.5 rounded-full bg-green-400 mr-3 shadow-md"></span>${user}`;
                    if (user === currentRecipient) {
                        li.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600', 'selected');
                    } else {
                        li.classList.add('text-gray-700', 'hover:bg-gray-100');
                    }
                    userList.appendChild(li);
                }
            });
        }
    </script>
</body>

</html>